# 最小完整示例项目指导文档（更新到当前源码）

本项目是一套可直接跑的最小完整示例（JDK 17 + Spring Boot 3.5.6 + WebFlux + Parquet 1.16.0 + Hadoop 3.4.1），演示：

- 生成 Parquet 并直接流式下载（不落地）
- Parquet → CSV：读一行写一行（不落地、不攒内存）
- Parquet → ZIP(CSV)：边生成 CSV 边压缩输出（不落地、不攒内存）
- CSV 输出 UTF-8；BINARY 输出 Base64 文本，保证 CSV 可读
- 不使用 `Flux<Map<...>>`/“每行一个 Map”对象流，避免慢客户端导致 OOM

说明：以当前仓库源码为准；本文档为导读，核心细节请以代码实现为准。

---

## 1) 运行

在父工程目录执行：

```bash
mvn -pl webflux-parquet-export-demo -DskipTests package
mvn -pl webflux-parquet-export-demo spring-boot:run
```

服务默认端口 `8080`（见 `src/main/resources/application.yml`）。

---

## 2) 接口

### 2.1 生成 Parquet（直接下载）

`POST /demo/generate?rows=800000`

- 直接把 Parquet 写到响应流，不创建本地文件
- 文件名随机生成（安全字母数字）

对应实现：

- `src/main/java/com/aquarius/wizard/webfluxparquetexportdemo/service/DemoGenerateService.java`
- `src/main/java/com/aquarius/wizard/webfluxparquetexportdemo/service/ParquetGenerateService.java`

### 2.2 下载导出

`GET /demo/download?format=zip|csv|parquet&source=s3a://bucket/key.parquet&rows=...`

- `format` 支持大小写（默认 ZIP）
- `source` 在 demo 中仅用于模拟远端对象；实际生成临时 parquet 再导出
- `rows` 仅 demo 用于控制生成的行数

对应实现：

- `src/main/java/com/aquarius/wizard/webfluxparquetexportdemo/service/DemoDownloadService.java`
- `src/main/java/com/aquarius/wizard/webfluxparquetexportdemo/service/ParquetStagingService.java`
- `src/main/java/com/aquarius/wizard/webfluxparquetexportdemo/service/ParquetExportService.java`

---

## 3) 配置项（application.yml）

`demo.export` 下主要参数：

- `chunk-size`：响应 DataBuffer 分片大小
- `output-buffer-size`：CSV/ZIP 输出缓冲
- `csv-flush-header` / `csv-flush-every-bytes`
- `zip-flush-header` / `zip-flush-every-bytes`
- `zip-level`
- `executor-properties.pool-size` / `queue-capacity` / `keep-alive`

配置类：

- `src/main/java/com/aquarius/wizard/webfluxparquetexportdemo/config/ExportProperties.java`
- `src/main/java/com/aquarius/wizard/webfluxparquetexportdemo/config/ExportExecutorProperties.java`
- `src/main/java/com/aquarius/wizard/webfluxparquetexportdemo/config/ExportConfig.java`

---

## 4) 代码结构（当前包名）

```
src/main/java/com/aquarius/wizard/webfluxparquetexportdemo/
  DemoApplication.java
  config/
    ExportConfig.java
    ExportProperties.java
    ExportExecutorProperties.java
    WebConfig.java
  controller/
    DemoController.java
  demo/
    DemoParquetGenerator.java
  io/
    CountingOutputStream.java
    OutputStreamOutputFile.java
  model/
    FileFormat.java
  parquet/
    ParquetToCsvCellValueConverter.java
  service/
    DemoGenerateService.java
    DemoDownloadService.java
    ParquetGenerateService.java
    ParquetExportService.java
    ParquetStagingService.java
  util/
    CsvUtil.java
    Int96Util.java
    RandomNameGenerator.java
```

---

## 5) 核心流程

### 5.1 生成 Parquet（流式）

- `ParquetGenerateService` 使用 `DataBufferUtils.outputStreamPublisher` 把 ParquetWriter 写到响应流
- 通过 `OutputStreamOutputFile` 让 ParquetWriter 直接写到 `OutputStream`
- `StreamUtils.nonClosing(...)` 避免提前关闭响应流

### 5.2 下载导出（Parquet/CSV/ZIP）

- `ParquetStagingService` 模拟远端下载：先生成“远端 parquet”，再通过 InputStream 复制到本地临时文件
- `DemoDownloadService` 使用 `Mono.usingWhen` 确保完成/取消时清理临时文件
- `ParquetExportService` 负责三种格式的流式输出：
  - PARQUET：`DataBufferUtils.read(...)` 直接读文件
  - CSV：行读行写，不落地、不攒内存
  - ZIP：`ZipOutputStream` 边写边压缩，ZIP 内只有一个 CSV entry

### 5.3 CSV 生成与类型映射

- `CsvUtil` 负责 CSV 转义/输出（RFC4180 最小规则）
- `ParquetToCsvCellValueConverter` 解析 Parquet 物理/逻辑类型（含 legacy ConvertedType）
- `Int96Util` 支持 INT96 <-> Instant

---

## 6) 编码与数据策略

- CSV 统一 UTF-8
- BINARY 类型输出 Base64 文本，保证 CSV 可读与可跨工具解析
- INT96 输出 ISO-8601 时间字符串（Instant）

---

## 7) 背压与 OOM 风险控制

- 不构造 `Flux<Map<...>>` 行对象流，避免慢客户端导致对象堆积
- `DataBufferUtils.outputStreamPublisher` + 阻塞写入：客户端慢 -> `write` 变慢 -> 上游自然降速
- 导出任务运行在**有界线程池**，队列满直接 503，防止把阻塞 IO 跑到 Netty 线程
- CSV/ZIP 输出提供“首包 flush + 周期性 flush”与缓冲设置，平衡延迟与吞吐

---

## 8) 指标与可观测性

已集成基础导出指标（通过 Actuator `/actuator/metrics` 暴露）：

- `demo.export.duration`：导出耗时（按 `operation`/`format` 标签区分）
- `demo.export.bytes`：累计导出字节数
- `demo.export.rejections`：导出线程池拒绝次数
- `demo.export.executor.queue.size` / `demo.export.executor.queue.remaining`
- `demo.export.executor.active` / `demo.export.executor.pool.size`

---

## 9) 细节说明与可选优化

- CsvUtil 里使用 `','`、`'"'`、`'\n'`、`'\r'` 这样的 `char` 字面量是编译期常量，不会产生额外对象。
  即使抽成 `String` 常量，内存/性能差异也可以忽略；是否抽常量主要取决于可读性/风格。

不改架构前提下可考虑的优化点：

- 加“硬限制策略”：最大行数/字节数/最大导出时长，避免极端任务占用过久
- 增加“列投影/条件过滤”：减少输出体积，直接降低 CPU/IO/网络
- 异步导出到对象存储：超大导出转为任务+下载链接，减少长连接风险
- 指标与告警：导出耗时/队列深度/拒绝次数/累计字节，帮助容量评估
- 细化并发与配额：按租户/用户限流，防止高并发拖垮导出池

---

## 10) 与旧文档主要差异

- 包名为 `com.aquarius.wizard.webfluxparquetexportdemo`
- `POST /demo/generate` 直接流式返回 Parquet（不落地本地文件）
- BINARY 输出策略已改为 Base64（UTF-8 CSV）
- 代码结构拆分为 `DemoGenerateService` / `DemoDownloadService` / `ParquetExportService` 等模块
